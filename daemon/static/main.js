// Generated by CoffeeScript 1.6.3
(function() {
  var adjustZoom, createMachine, machineGroups, photoHeight, photoWidth, zoom;

  photoWidth = 15;

  photoHeight = 20;

  zoom = d3.behavior.zoom();

  adjustZoom = function() {
    return d3.select('#viewport').attr('transform', "translate(" + d3.event.translate + ") scale(" + d3.event.scale + ")");
  };

  machineGroups = ['pixel', 'texel', 'matrix', 'visual', 'corona', 'edge', 'unsgnd'];

  createMachine = function(d, i) {
    var g, x, y;
    g = d3.select(this);
    x = d.pos.x - photoWidth / 2;
    y = d.pos.y - photoHeight / 2;
    g.append('title').text(d.hostname);
    return g.append('rect').attr('x', x).attr('y', y).attr('width', photoWidth).attr('height', photoHeight).attr('clip-path', 'url(#photo-clip-path)').attr('fill', colorbrewer.Pastel2[7][machineGroups.indexOf(d.group)]);
    /*
    g.append('image')
      .attr('id', (d) -> d.hostname)
      .attr('x', (d) -> d.pos.x - photoWidth / 2)
      .attr('y', (d) -> d.pos.y - photoHeight / 2)
      .attr('width', photoWidth)
      .attr('height', photoHeight)
      .attr('clip-path', 'url(#photo-clip-path)')
      .attr('xlink:href', 'jr1610.jpg')
    */

  };

  d3.xml('labmap.svg', 'image/svg+xml', function(xml) {
    var svg;
    svg = d3.select('#map').select(function() {
      return this.appendChild(xml.documentElement);
    });
    svg.call(zoom.on('zoom', adjustZoom));
    return d3.json('layout.json', function(err, layout) {
      var desc, descs, dist, i, machine, machines, spline, splineLen, splineMachines, _i, _j, _k, _len, _len1, _ref, _ref1;
      machines = [];
      for (spline in layout) {
        descs = layout[spline];
        spline = d3.select('#' + spline)[0][0];
        splineLen = spline.getTotalLength();
        splineMachines = [];
        for (_i = 0, _len = descs.length; _i < _len; _i++) {
          desc = descs[_i];
          for (i = _j = _ref = desc['from'], _ref1 = desc['to']; _ref <= _ref1 ? _j <= _ref1 : _j >= _ref1; i = _ref <= _ref1 ? ++_j : --_j) {
            splineMachines.push({
              group: desc['group'],
              hostname: desc['group'] + i
            });
          }
        }
        for (i = _k = 0, _len1 = splineMachines.length; _k < _len1; i = ++_k) {
          machine = splineMachines[i];
          dist = splineMachines.length === 1 ? 0 : splineLen * i / (splineMachines.length - 1);
          machine.pos = spline.getPointAtLength(dist);
        }
        machines = machines.concat(splineMachines);
      }
      return d3.select('#computers').selectAll('g').data(machines).enter().append('g').each(createMachine);
    });
  });

}).call(this);
